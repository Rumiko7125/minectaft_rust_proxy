import{d as _e,u as be,o as ke,c as P,e as i,t as d,g as r,f as l,w as s,B as y,n as D,ag as Q,r as p,aj as w,a5 as he,ak as xe,i as x,j as A,P as Ae,m as X,q as Fe,p as V,C as u,al as Ie}from"./index-DQgClpag.js";import{N as Ne}from"./Select-Dy_GmTdc.js";import{N as Y}from"./InputNumber-B9FQEIAe.js";import{u as Pe,N as q}from"./use-message-DfHQKw6A.js";import{N as we,a as Re,b as Ce}from"./DataTable-BmjeHeaD.js";import{N as $e}from"./Form-CpuxP8S5.js";import{N as j}from"./FormItem-8Lqb3O-i.js";import{N as Z}from"./Tag-B2_cy-hE.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./Popover-BT2YCJ3w.js";import"./Checkmark-BOYRWfKy.js";import"./Add-C00RkFDM.js";import"./Dropdown-BYzVsjoG.js";import"./get-slot-Bk_rJcZu.js";const je={class:"page-container"},Be={class:"page-header"},Se={class:"page-title"},Ue={class:"page-subtitle"},ze={style:{display:"flex",gap:"8px","align-items":"center"}},Me={class:"routes-table-wrap"},Ee={class:"pagination-row"},Te={key:0,class:"empty-state"},Oe={class:"empty-text"},Le={key:0,class:"prefix-input-row"},He={class:"domain-suffix"},Je={key:0,class:"form-error"},Ve={class:"form-hint"},qe={key:0,class:"backend-preview"},We={class:"backend-preview-label"},Ge={class:"backend-preview-value"},Ke={style:{display:"flex","justify-content":"flex-end",gap:"8px"}},Qe={style:{color:"#8b949e"}},Xe={style:{display:"flex","justify-content":"flex-end",gap:"8px"}},Ye=_e({__name:"Routes",setup(Ze){const{t:o}=be(),m=Pe(),B=p(!1),F=p(!1),E=p([]),_=p([]),W=p(null),T=p(1),S=p(20),G=p(0),v=p(""),O=p({}),U=p({}),I=p(!1),R=p(null),h=p(!1),a=Fe({pattern:"",patternPrefix:"",backendId:null,targetAddr:"",targetPort:25565,priority:0}),C=p(!1),z=p(null),ee=V(()=>_.value.map(e=>({label:e.name+(e.maintenance?` [${o("backend.maintenanceEnabled")}]`:""),value:e.id,disabled:!e.enabled}))),te=V(()=>{var e;return a.backendId&&((e=_.value.find(t=>t.id===a.backendId))==null?void 0:e.name)||""}),ae=V(()=>{if(!a.backendId)return"";const e=_.value.find(t=>t.id===a.backendId);return e?`${e.remote_address}:${e.remote_port}`:""});function ne(){if(!a.pattern){h.value=!1;return}try{new RegExp(a.pattern),h.value=!1}catch{h.value=!0}}function re(){v.value&&(a.pattern=a.patternPrefix?`${a.patternPrefix}.${v.value}`:v.value)}async function oe(e){var b,g;const t=e.id;if(U.value[t])return;const n=e.target_addr||((b=_.value.find(f=>f.id===e.backend_id))==null?void 0:b.remote_address),c=e.target_port||((g=_.value.find(f=>f.id===e.backend_id))==null?void 0:g.remote_port)||25565;if(!n){m.warning(o("routes.pingNoAddr"));return}U.value[t]=!0;try{const f=await Ie.ping(n,c);O.value[t]=f}catch(f){O.value[t]={error:f.message}}finally{U.value[t]=!1}}function le(e){if(e){const t=_.value.find(n=>n.id===e);t&&(a.targetAddr=t.remote_address,a.targetPort=t.remote_port)}}function K(){R.value=null,a.pattern="",a.patternPrefix="",a.backendId=null,a.targetAddr="",a.targetPort=25565,a.priority=0,h.value=!1,I.value=!0}function se(e){R.value=e,a.pattern=e.pattern,v.value&&e.pattern&&e.pattern.endsWith(`.${v.value}`)?a.patternPrefix=e.pattern.slice(0,-(v.value.length+1)):v.value&&e.pattern===v.value?a.patternPrefix="":a.patternPrefix=e.pattern,a.backendId=e.backend_id||null,a.targetAddr=e.target_addr||"",a.targetPort=e.target_port||25565,a.priority=e.priority||0,h.value=!1,I.value=!0}async function ie(){if(!a.pattern||h.value){m.error(o("routes.patternInvalid"));return}if(!a.backendId&&!a.targetAddr){m.error(o("routes.targetRequired"));return}F.value=!0;try{const e={pattern:a.pattern,backend_id:a.backendId,target_addr:a.backendId?void 0:a.targetAddr,target_port:a.backendId?void 0:a.targetPort,priority:a.priority};R.value?await w.updateDomainRoute(R.value.id,e):await w.addDomainRoute(e),m.success(o("common.success")),I.value=!1,await $()}catch(e){m.error(e.message||o("common.operationFailed"))}finally{F.value=!1}}function de(e){z.value=e,C.value=!0}async function ue(){if(z.value){F.value=!0;try{await w.deleteDomainRoute(z.value.id),m.success(o("common.deleteSuccess")),C.value=!1,await $()}catch(e){m.error(e.message||o("common.deleteFailed"))}finally{F.value=!1}}}const ce=[{title:()=>o("table.pattern"),key:"pattern",render:e=>u("code",{class:"pattern-code"},e.pattern)},{title:()=>o("routes.selectBackend"),key:"backend",render:e=>{if(e.backend_id){const t=_.value.find(n=>n.id===e.backend_id);return t?u(Ce,{trigger:"hover",placement:"top"},{default:()=>`${t.remote_address}:${t.remote_port}`,trigger:()=>u(Z,{type:"info",size:"small",style:"cursor:default"},{default:()=>t.name})}):u("span",{class:"text-muted"},`#${e.backend_id}`)}return u("span",{class:"text-muted font-mono"},`${e.target_addr||""}:${e.target_port||""}`)}},{title:()=>o("table.priority"),key:"priority",width:80,render:e=>u(Z,{size:"small",type:"default"},{default:()=>e.priority??0})},{title:()=>o("routes.motdPreview"),key:"ping",width:240,render:e=>{const t=O.value[e.id],n=!!U.value[e.id],c=u(y,{size:"small",loading:n,onClick:()=>oe(e)},{default:()=>o(t?"routes.pingRefresh":"routes.pingPreview")});return t?t.error?u("div",{style:"display:flex;gap:6px;align-items:center"},[c,u("span",{style:"color:#f85149;font-size:11px"},o("routes.pingFailed"))]):u("div",{class:"ping-result"},[c,u("div",{class:"ping-card"},[t.favicon?u("img",{src:t.favicon,class:"ping-favicon"}):null,u("div",{class:"ping-info"},[u("div",{class:"ping-version"},`${t.version_name} Â· ${t.online}/${t.max} Â· ${t.latency_ms}ms`),u("div",{class:"ping-motd",innerHTML:pe(t.description)})])])]):c}},{title:()=>o("common.action"),key:"action",width:120,render:e=>u("div",{style:"display:flex;gap:6px"},[u(y,{size:"small",onClick:()=>se(e)},{default:()=>o("common.edit")}),u(y,{size:"small",type:"error",onClick:()=>de(e)},{default:()=>o("common.delete")})])}],L={0:"#000",1:"#0000AA",2:"#00AA00",3:"#00AAAA",4:"#AA0000",5:"#AA00AA",6:"#FFAA00",7:"#AAAAAA",8:"#555555",9:"#5555FF",a:"#55FF55",b:"#55FFFF",c:"#FF5555",d:"#FF55FF",e:"#FFFF55",f:"#FFFFFF"};function pe(e){if(!e)return"";if(typeof e=="object")try{e=JSON.stringify(e)}catch{return""}try{const t=JSON.parse(e);if(typeof t=="object")return H(t)}catch{}return J(e)}function H(e){if(typeof e=="string")return J(e);if(Array.isArray(e))return e.map(H).join("");const t=e.color?L[e.color]||e.color:"";let n=t?`color:${t};`:"";e.bold&&(n+="font-weight:bold;"),e.italic&&(n+="font-style:italic;");const c=e.text?J(e.text):"",b=(e.extra||[]).map(H).join("");return`<span style="${n}">${c}${b}</span>`}function J(e){let t="",n=0;for(;n<e.length;)if((e[n]==="Â§"||e[n]==="&")&&n+1<e.length){const c=e[n+1].toLowerCase();L[c]&&(t+=`<span style="color:${L[c]}">`),n+=2}else t+=e[n]==="<"?"&lt;":e[n]===">"?"&gt;":e[n],n++;return t||e}async function $(){B.value=!0;try{const e=await w.getDomainRoutes({limit:S.value,offset:(T.value-1)*S.value});E.value=e.routes||[],G.value=e.total||0}catch(e){console.error(e)}finally{B.value=!1}}async function fe(){try{const[e,t]=await Promise.all([he.list(),xe.get()]);_.value=e.list||[],v.value=t.trusted_domain||""}catch(e){console.error(e)}}async function me(){try{const t=(await w.getDomainRoutes({limit:1e4})).routes||[],n={version:1,exported_at:new Date().toISOString(),routes:t.map(g=>{const f=_.value.find(k=>k.id===g.backend_id);return{pattern:g.pattern,target_addr:g.target_addr||"",target_port:g.target_port||25565,priority:g.priority??0,backend_name:(f==null?void 0:f.name)||null}})},c=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),b=document.createElement("a");b.href=URL.createObjectURL(c),b.download="routes_config.json",b.click(),m.success(o("common.success"))}catch(e){m.error(e.message||o("common.operationFailed"))}}function ve(){var e;(e=W.value)==null||e.click()}async function ge(e){var n;const t=(n=e.target.files)==null?void 0:n[0];if(t){e.target.value="";try{const c=await t.text(),g=JSON.parse(c).routes||[];if(!g.length){m.warning(o("routes.importEmpty"));return}let f=0;for(const k of g){if(!k.pattern)continue;const M=k.backend_name?_.value.find(ye=>ye.name===k.backend_name):null,N={pattern:k.pattern,priority:k.priority??0};M?(N.backend_id=M.id,N.target_addr=M.remote_address,N.target_port=M.remote_port):(N.target_addr=k.target_addr||"",N.target_port=k.target_port||25565);try{await w.addDomainRoute(N),f++}catch{}}m.success(o("routes.importSuccess",{n:f})),await $()}catch(c){m.error(c.message||o("common.operationFailed"))}}}return ke(()=>{$(),fe()}),(e,t)=>(x(),P("div",je,[i("div",Be,[i("div",null,[i("h1",Se,d(r(o)("nav.routes")),1),i("p",Ue,d(r(o)("routes.subtitle")),1)]),i("div",ze,[l(r(y),{onClick:me},{default:s(()=>[A(d(r(o)("routes.exportRoutes")),1)]),_:1}),l(r(y),{onClick:ve},{default:s(()=>[A(d(r(o)("routes.importRoutes")),1)]),_:1}),l(r(y),{type:"primary",onClick:K},{icon:s(()=>[...t[11]||(t[11]=[i("span",null,"+",-1)])]),default:s(()=>[A(" "+d(r(o)("routes.addDomainRoute")),1)]),_:1})]),i("input",{ref_key:"routeFileInput",ref:W,type:"file",accept:"application/json,.json",style:{display:"none"},onChange:ge},null,544)]),i("div",Me,[l(r(we),{columns:ce,data:E.value,loading:B.value,bordered:!1,size:"small"},null,8,["data","loading"]),i("div",Ee,[l(r(Re),{page:T.value,"onUpdate:page":[t[0]||(t[0]=n=>T.value=n),$],"page-count":Math.ceil(G.value/S.value),"page-size":S.value},null,8,["page","page-count","page-size"])])]),!B.value&&E.value.length===0?(x(),P("div",Te,[t[12]||(t[12]=i("div",{class:"empty-icon"},"ðŸ—º",-1)),i("div",Oe,d(r(o)("routes.emptyHint")),1),l(r(y),{type:"primary",onClick:K},{default:s(()=>[A(d(r(o)("routes.addDomainRoute")),1)]),_:1})])):D("",!0),l(r(Q),{show:I.value,"onUpdate:show":t[8]||(t[8]=n=>I.value=n),preset:"card",title:R.value?r(o)("routes.editDomainRoute"):r(o)("routes.addDomainRoute"),style:{width:"520px"}},{footer:s(()=>[i("div",Ke,[l(r(y),{onClick:t[7]||(t[7]=n=>I.value=!1)},{default:s(()=>[A(d(r(o)("common.cancel")),1)]),_:1}),l(r(y),{type:"primary",loading:F.value,onClick:ie},{default:s(()=>[A(d(r(o)("common.confirm")),1)]),_:1},8,["loading"])])]),default:s(()=>[l(r($e),{model:a,"label-placement":"left","label-width":120},{default:s(()=>[l(r(j),{label:r(o)("table.pattern"),required:""},{default:s(()=>[v.value?(x(),P("div",Le,[l(r(q),{value:a.patternPrefix,"onUpdate:value":t[1]||(t[1]=n=>a.patternPrefix=n),placeholder:r(o)("routes.prefixPlaceholder"),style:{flex:"1"},onInput:re},null,8,["value","placeholder"]),i("span",He,"."+d(v.value),1)])):(x(),P(Ae,{key:1},[l(r(q),{value:a.pattern,"onUpdate:value":t[2]||(t[2]=n=>a.pattern=n),placeholder:r(o)("routes.patternPlaceholder"),status:h.value?"error":void 0,onInput:ne},null,8,["value","placeholder","status"]),h.value?(x(),P("div",Je,d(r(o)("routes.patternInvalid")),1)):D("",!0)],64))]),_:1},8,["label"]),l(r(j),{label:r(o)("routes.selectBackend")},{default:s(()=>[l(r(Ne),{value:a.backendId,"onUpdate:value":[t[3]||(t[3]=n=>a.backendId=n),le],options:ee.value,clearable:"",placeholder:r(o)("routes.selectBackendPlaceholder")},null,8,["value","options","placeholder"])]),_:1},8,["label"]),a.backendId?D("",!0):(x(),X(r(j),{key:0,label:r(o)("routes.targetAddr")},{default:s(()=>[l(r(q),{value:a.targetAddr,"onUpdate:value":t[4]||(t[4]=n=>a.targetAddr=n),placeholder:"127.0.0.1"},null,8,["value"])]),_:1},8,["label"])),a.backendId?D("",!0):(x(),X(r(j),{key:1,label:r(o)("routes.targetPort")},{default:s(()=>[l(r(Y),{value:a.targetPort,"onUpdate:value":t[5]||(t[5]=n=>a.targetPort=n),min:1,max:65535,style:{width:"100%"}},null,8,["value"])]),_:1},8,["label"])),l(r(j),{label:r(o)("table.priority")},{default:s(()=>[l(r(Y),{value:a.priority,"onUpdate:value":t[6]||(t[6]=n=>a.priority=n),style:{width:"100%"}},null,8,["value"]),i("div",Ve,d(r(o)("routes.priorityHelp")),1)]),_:1},8,["label"])]),_:1},8,["model"]),a.backendId?(x(),P("div",qe,[i("div",We,d(r(o)("routes.routeTarget")),1),i("div",Ge,d(te.value)+" ("+d(ae.value)+") ",1)])):D("",!0)]),_:1},8,["show","title"]),l(r(Q),{show:C.value,"onUpdate:show":t[10]||(t[10]=n=>C.value=n),preset:"card",title:r(o)("common.confirmDelete"),style:{width:"400px"}},{footer:s(()=>[i("div",Xe,[l(r(y),{onClick:t[9]||(t[9]=n=>C.value=!1)},{default:s(()=>[A(d(r(o)("common.cancel")),1)]),_:1}),l(r(y),{type:"error",loading:F.value,onClick:ue},{default:s(()=>[A(d(r(o)("common.delete")),1)]),_:1},8,["loading"])])]),default:s(()=>{var n;return[i("p",Qe,d(r(o)("common.confirmDeleteMsg",{target:(n=z.value)==null?void 0:n.pattern})),1)]}),_:1},8,["show","title"])]))}}),mt=De(Ye,[["__scopeId","data-v-9585d775"]]);export{mt as default};
